<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Questions List</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}">
</head>
<body>

<div th:insert="~{fragments::menu}"></div>

<div class="container mt-3">
<!--    <h2>Questions</h2>-->

    <div th:if="${message}" class="alert" th:text="${message}"></div>

    <!-- Search Filter Section -->
    <div class="searchfilter">
        <form method="post" th:action="@{/questions/filter}" class="searchfilter-form">
            <div>
                <label for="courseFilter" class="searchfilter-label">Course</label>
                <select id="courseFilter" name="course" class="searchfilter-select">
                    <option value="">All Courses</option>
                    <option th:each="course : ${courses}"
                            th:value="${course}"
                            th:text="${course}"
                            th:selected="${course} == ${selectedCourse}"></option>
                </select>
            </div>
            <div>
                <label for="quizFilter" class="searchfilter-label">Quiz</label>
                <select id="quizFilter" name="quizId" class="searchfilter-select">
                    <option value="">All Quizzes</option>
                    <option th:each="quiz : ${quizzes}"
                            th:value="${quiz.id}"
                            th:text="${quiz.name}"
                            th:selected="${quiz.id} == ${selectedQuizId}"></option>
                </select>
            </div>
            <div>
                <label for="authorFilter" class="searchfilter-label">Author</label>
                <select name="authorId" id="authorFilter" class="searchfilter-select">
                    <option value="">All Authors</option>
                    <option th:each="author : ${authors}"
                            th:value="${author.id}"
                            th:text="${author.name}"
                            th:selected="${author.id} == ${selectedAuthorId}"></option>
                </select>
            </div>
            <div>
                <label for="typeFilter" class="searchfilter-label">Question Type</label>
                <select id="typeFilter" name="type" class="searchfilter-select">
                    <option value="">All Types</option>
                    <option value="MULTICHOICE" th:selected="${selectedType} == 'MULTICHOICE'">Multiple Choice</option>
                    <option value="TRUEFALSE" th:selected="${selectedType} == 'TRUEFALSE'">True/False</option>
                </select>
            </div>
            <div>
                <label for="pageSize" class="searchfilter-label">Page Size</label>
                <select id="pageSize" name="pageSize" class="searchfilter-select">
                    <option th:selected="${pageSize == 5}" value="5">5</option>
                    <option th:selected="${pageSize == 10}" value="10">10</option>
                    <option th:selected="${pageSize == 20}" value="20">20</option>
                    <option th:selected="${pageSize == 50}" value="50">50</option>
                </select>
            </div>
            <div>
                <label for="currentPage" class="searchfilter-label">Page</label>
                <input type="number" id="currentPage" name="page"
                       th:value="${currentPage != null ? currentPage : 1}"
                       min="1"
                       class="searchfilter-select" style="width: 80px;" />
            </div>
            <button type="submit" class="btn-filter">üîç Filter Questions</button>
        </form>
    </div>

    <!-- Error Message -->
    <div th:if="${errorMessage}" class="alert mt-3" th:text="${errorMessage}"></div>

    <!-- Styled Table -->
    <table class="styled-table" style="width:100%">
        <thead>
        <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Title</th>
            <th>Chapter</th>
            <th>Course</th>
            <th>Author</th>
            <th>Quiz</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="question : ${questions}" class="data-row">
            <td th:text="${question.id}"></td>
            <td th:text="${question.type}"></td>
            <td th:text="${question.title}"></td>
            <td th:text="${question.chapter}"></td>
            <td th:text="${question.course}"></td>
            <td th:text="${question.authorName}"></td>
            <td th:text="${question.quizName}"></td>
            <td class="action-cell">
                <a th:href="@{'/questions/' + ${question.id}}" class="btn btn-info">üëÅÔ∏è View</a>
                <a th:href="@{'/questions/' + ${question.id} + '/correction'}" class="btn btn-new">ü§ñ AI Correct</a>
                <button th:onclick="|deleteQuestion(${question.id})|" class="btn btn-outline">üóëÔ∏è Delete</button>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(questions)}" class="empty-row">
            <td colspan="8">No questions found for the selected criteria</td>
        </tr>
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="pagination-controls" th:if="${totalPages != null && totalPages > 1}">
        <div style="display: flex; align-items: center; gap: 10px;">
            <!-- First Button -->
            <a th:if="${currentPage != null && currentPage > 1}"
               th:href="@{/questions(course=${selectedCourse}, quizId=${selectedQuizId}, authorId=${selectedAuthorId}, type=${selectedType}, page=1, pageSize=${pageSize != null ? pageSize : 10})}"
               class="btn btn-outline">‚èÆÔ∏è First</a>
            <span th:if="${currentPage == null || currentPage <= 1}" class="btn btn-outline disabled">‚èÆÔ∏è First</span>

            <!-- Previous Button -->
            <a th:if="${currentPage != null && currentPage > 1}"
               th:href="@{/questions(course=${selectedCourse}, quizId=${selectedQuizId}, authorId=${selectedAuthorId}, type=${selectedType}, page=${currentPage - 1}, pageSize=${pageSize != null ? pageSize : 10})}"
               class="btn btn-outline">‚¨ÖÔ∏è Previous</a>
            <span th:if="${currentPage == null || currentPage <= 1}" class="btn btn-outline disabled">‚¨ÖÔ∏è Previous</span>

            <span>Page <span th:text="${currentPage != null ? currentPage : 1}"></span> of <span th:text="${totalPages}"></span></span>

            <!-- Next Button -->
            <a th:if="${currentPage != null && currentPage < totalPages}"
               th:href="@{/questions(course=${selectedCourse}, quizId=${selectedQuizId}, authorId=${selectedAuthorId}, type=${selectedType}, page=${currentPage + 1}, pageSize=${pageSize != null ? pageSize : 10})}"
               class="btn btn-outline">‚û°Ô∏è Next</a>
            <span th:if="${currentPage == null || currentPage >= totalPages}" class="btn btn-outline disabled">‚û°Ô∏è Next</span>

            <!-- Last Button -->
            <a th:if="${currentPage != null && currentPage < totalPages}"
               th:href="@{/questions(course=${selectedCourse}, quizId=${selectedQuizId}, authorId=${selectedAuthorId}, type=${selectedType}, page=${totalPages}, pageSize=${pageSize != null ? pageSize : 10})}"
               class="btn btn-outline">‚è≠Ô∏è Last</a>
            <span th:if="${currentPage == null || currentPage >= totalPages}" class="btn btn-outline disabled">‚è≠Ô∏è Last</span>
        </div>
    </div>

    <!-- Total Elements -->
    <div class="total-elements" th:if="${totalElements != null}">
        Total: <span th:text="${totalElements}"></span> question(s) found
    </div>

    <!-- Quiz-specific questions if viewing by quiz -->
    <div th:if="${quiz != null}">
        <h3>üìä Quiz: <span th:text="${quiz.name + ' (' + quiz.course + ')'}"></span></h3>

        <h4>Multiple Choice Questions</h4>
        <table class="styled-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Chapter</th>
                <th>Row</th>
                <th>Title</th>
                <th>Text</th>
                <th>Response 1</th>
                <th>Response 2</th>
                <th>Response 3</th>
                <th>Response 4</th>
                <th>Weight 1</th>
                <th>Weight 2</th>
                <th>Weight 3</th>
                <th>Weight 4</th>
                <th>Author</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="questionDto : ${quiz.questionsMC}" class="data-row">
                <td th:text="${questionDto.id}"></td>
                <td th:text="${questionDto.chapter}"></td>
                <td th:text="${questionDto.row}"></td>
                <td th:text="${questionDto.title}"></td>
                <td th:text="${questionDto.text}"></td>
                <td th:text="${questionDto.response1}"></td>
                <td th:text="${questionDto.response2}"></td>
                <td th:text="${questionDto.response3}"></td>
                <td th:text="${questionDto.response4}"></td>
                <td th:text="${questionDto.weightResponse1}"></td>
                <td th:text="${questionDto.weightResponse2}"></td>
                <td th:text="${questionDto.weightResponse3}"></td>
                <td th:text="${questionDto.weightResponse4}"></td>
                <td th:text="${questionDto.authorName}"></td>
                <td class="action-cell">
                    <a th:href="@{'/questions/' + ${questionDto.id}}" class="btn btn-info">üëÅÔ∏è View</a>
                    <a th:href="@{'/questions/' + ${questionDto.id} + '/edit'}" class="btn btn-info">‚úèÔ∏è Edit</a>
                    <button th:onclick="|deleteQuestion(${questionDto.id})|" class="btn btn-outline">üóëÔ∏è Delete</button>
                </td>
            </tr>
            <tr th:if="${quiz.questionsMC == null or #lists.isEmpty(quiz.questionsMC)}" class="empty-row">
                <td colspan="15">No multiple choice questions found for the selected criteria</td>
            </tr>
            </tbody>
        </table>

        <h4>True/False Questions</h4>
        <table class="styled-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Chapter</th>
                <th>Title</th>
                <th>Row</th>
                <th>Text</th>
                <th>Weight TRUE</th>
                <th>Weight FALSE</th>
                <th>Correct Answer</th>
                <th>Author</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="questionDto : ${quiz.questionsTF}" class="data-row">
                <td th:text="${questionDto.id}"></td>
                <td th:text="${questionDto.chapter}"></td>
                <td th:text="${questionDto.title}"></td>
                <td th:text="${questionDto.row}"></td>
                <td th:text="${questionDto.text}"></td>
                <td th:text="${questionDto.weightTrue}"></td>
                <td th:text="${questionDto.weightFalse}"></td>
                <td th:text="${questionDto.response1}"></td>
                <td th:text="${questionDto.authorName}"></td>
                <td class="action-cell">
                    <a th:href="@{'/questions/' + ${questionDto.id}}" class="btn btn-info">üëÅÔ∏è View</a>
                    <a th:href="@{'/questions/' + ${questionDto.id} + '/edit'}" class="btn btn-info">‚úèÔ∏è Edit</a>
                    <button th:onclick="|deleteQuestion(${questionDto.id})|" class="btn btn-outline">üóëÔ∏è Delete</button>
                </td>
            </tr>
            <tr th:if="${quiz.questionsTF == null or #lists.isEmpty(quiz.questionsTF)}" class="empty-row">
                <td colspan="10">No true/false questions found for the selected criteria</td>
            </tr>
            </tbody>
        </table>

        <h4>Author Errors</h4>
        <table class="styled-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>Row</th>
                <th>Description</th>
                <th>Author</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="error : ${quiz.authorErrors}" class="data-row">
                <td th:text="${error.id}"></td>
                <td th:text="${error.row}"></td>
                <td th:text="${error.description}"></td>
                <td th:text="${error.authorName}"></td>
            </tr>
            <tr th:if="${quiz.authorErrors == null or #lists.isEmpty(quiz.authorErrors)}" class="empty-row">
                <td colspan="4">No author errors found for the selected criteria</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
        fetch('/questions/' + questionId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                throw new Error('Failed to delete question');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting question: ' + error.message);
        });
    }
}
</script>

</body>
</html>