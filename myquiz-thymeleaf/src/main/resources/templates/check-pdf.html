<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PDF Check with AI</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}">
</head>
<body>

<div th:insert="~{fragments::menu}"></div>

<div class="container mt-3">
    <h2>üìÑ PDF Check with AI</h2>
    <p>Upload a PDF file and ask questions about its content using AI.</p>

    <!-- Ollama Connection Status -->
    <div id="ollama-status" class="status-indicator">
        <span id="status-text">Checking Ollama connection...</span>
        <button onclick="checkOllamaStatus()" class="btn btn-sm" style="margin-left: 10px;">üîÑ Check Status</button>
    </div>

    <!-- Model Selection (shown when models are available) -->
    <div id="model-selection" class="form-group" style="display: none;">
        <label for="llm-model" class="form-label">Select AI Model:</label>
        <select id="llm-model" class="form-select">
            <option value="">Loading models...</option>
        </select>
    </div>

    <!-- PDF Upload and Question Form -->
    <div class="form-container">
        <h3>üì§ Upload PDF and Ask Question</h3>

        <form id="pdf-question-form" onsubmit="submitQuestion(event)">
            <div class="form-group">
                <label for="pdf-file" class="form-label">Upload PDF File:</label>
                <input type="file" id="pdf-file" name="file" accept=".pdf" required class="form-input">
                <small class="form-text">Maximum file size: 50MB</small>
            </div>

            <div class="form-group">
                <label for="question" class="form-label">Your Question:</label>
                <textarea id="question" name="question" rows="4"
                          placeholder="What would you like to know about this document?"
                          required class="form-textarea"></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-save" id="submit-btn">
                    üîç Ask Question
                </button>
                <button type="button" onclick="clearForm()" class="btn btn-secondary">
                    üóëÔ∏è Clear
                </button>
            </div>
        </form>
    </div>

    <!-- Response Section -->
    <div id="response-section" class="response-container" style="display: none;">
        <h3>üí¨ AI Response</h3>
        <div id="response-content" class="response-box">
            <!-- Response will be displayed here -->
        </div>
        <div id="response-meta" class="response-meta">
            <!-- Metadata will be displayed here -->
        </div>
    </div>

    <!-- Messages -->
    <div id="message-container"></div>

    <!-- Sample Questions -->
    <div class="samples-section">
        <h3>üí° Tips</h3>
        <ul>
            <li>Upload a PDF file containing text (scanned images won't work)</li>
            <li>Ask specific questions about the content</li>
            <li>The AI will analyze the document and provide answers based on its content</li>
            <li>Larger documents may take longer to process</li>
            <li>Make sure Ollama is running and at least one model is installed</li>
        </ul>
    </div>
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.mt-3 {
    margin-top: 20px;
}

.status-indicator {
    padding: 15px;
    margin: 20px 0;
    border-radius: 8px;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.status-indicator.online {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
}

.status-indicator.offline {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
}

.status-indicator.checking {
    background: #d1ecf1;
    border-color: #17a2b8;
    color: #0c5460;
}

.form-container {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin: 20px 0;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-text {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #666;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-save {
    background: #007bff;
    color: white;
}

.btn-save:hover {
    background: #0056b3;
}

.btn-save:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 12px;
}

.response-container {
    margin: 30px 0;
    padding: 25px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.response-box {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #28a745;
    margin-bottom: 15px;
    white-space: pre-wrap;
    line-height: 1.6;
}

.response-meta {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    font-size: 13px;
    color: #666;
    padding: 10px;
    background: #f1f3f5;
    border-radius: 6px;
}

.response-meta span {
    display: flex;
    align-items: center;
    gap: 5px;
}

.message {
    padding: 12px 20px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 4px solid;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.success {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
}

.message.error {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
}

.message.info {
    background: #d1ecf1;
    border-color: #17a2b8;
    color: #0c5460;
}

.samples-section {
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px solid #e9ecef;
}

.samples-section h3 {
    margin-top: 0;
    color: #333;
}

.samples-section ul {
    line-height: 1.8;
    color: #555;
}

@media (max-width: 768px) {
    .form-actions {
        flex-direction: column;
    }

    .btn {
        width: 100%;
    }
}
</style>

<script>
let availableModels = [];
let isOllamaConnected = false;

// Check Ollama status on page load
window.addEventListener('DOMContentLoaded', function() {
    checkOllamaStatus();
});

async function checkOllamaStatus() {
    const statusDiv = document.getElementById('ollama-status');
    const statusText = document.getElementById('status-text');
    const modelSelection = document.getElementById('model-selection');
    const modelSelect = document.getElementById('llm-model');

    statusDiv.className = 'status-indicator checking';
    statusText.textContent = 'Checking Ollama connection...';

    try {
        const response = await fetch('/check-pdf/ollama-status');
        const data = await response.json();

        if (data.status === 'online') {
            statusDiv.className = 'status-indicator online';
            statusText.textContent = '‚úÖ ' + data.message;
            isOllamaConnected = true;

            // Populate model dropdown
            if (data.models && data.models.length > 0) {
                availableModels = data.models;
                modelSelect.innerHTML = '';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
                modelSelection.style.display = 'block';
            }
        } else {
            statusDiv.className = 'status-indicator offline';
            statusText.textContent = '‚ùå ' + data.message;
            isOllamaConnected = false;
            modelSelection.style.display = 'none';
        }
    } catch (error) {
        console.error('Error checking Ollama status:', error);
        statusDiv.className = 'status-indicator offline';
        statusText.textContent = '‚ùå Cannot connect to Ollama service';
        isOllamaConnected = false;
        modelSelection.style.display = 'none';
    }
}

async function submitQuestion(event) {
    event.preventDefault();

    if (!isOllamaConnected) {
        showMessage('Ollama is not connected. Please check the connection.', 'error');
        return;
    }

    const fileInput = document.getElementById('pdf-file');
    const questionInput = document.getElementById('question');
    const modelSelect = document.getElementById('llm-model');
    const submitBtn = document.getElementById('submit-btn');

    if (!fileInput.files || fileInput.files.length === 0) {
        showMessage('Please select a PDF file', 'error');
        return;
    }

    const file = fileInput.files[0];
    const question = questionInput.value.trim();

    if (!question) {
        showMessage('Please enter a question', 'error');
        return;
    }

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ Processing...';

    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('question', question);
        if (modelSelect.value) {
            formData.append('model', modelSelect.value);
        }

        const response = await fetch('/check-pdf/ask', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            displayResponse(result);
            showMessage('Question answered successfully!', 'success');
        } else {
            showMessage('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error submitting question:', error);
        showMessage('Failed to submit question: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üîç Ask Question';
    }
}

function displayResponse(result) {
    const responseSection = document.getElementById('response-section');
    const responseContent = document.getElementById('response-content');
    const responseMeta = document.getElementById('response-meta');

    responseContent.textContent = result.answer;

    responseMeta.innerHTML = `
        <span>üìÑ File: <strong>${result.fileName}</strong></span>
        <span>ü§ñ Model: <strong>${result.model}</strong></span>
        <span>üìä PDF Length: <strong>${result.pdfLength} characters</strong></span>
    `;

    responseSection.style.display = 'block';
    responseSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function clearForm() {
    document.getElementById('pdf-question-form').reset();
    document.getElementById('response-section').style.display = 'none';
    document.getElementById('message-container').innerHTML = '';
}

function showMessage(text, type) {
    const container = document.getElementById('message-container');
    const message = document.createElement('div');
    message.className = `message ${type}`;
    message.textContent = text;
    container.appendChild(message);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        message.remove();
    }, 5000);
}
</script>

</body>
</html>

